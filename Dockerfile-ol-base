FROM conockrad/microprofile3:openjdk8

# Install opentracing usr feature
USER 0
RUN apt-get update \
    && apt-get install -y --no-install-recommends unzip wget \
    && rm -rf /var/lib/apt/lists/* \
    && wget -t 10 -x -nd -P /opt/ol/wlp/usr https://github.com/WASdev/sample.opentracing.zipkintracer/releases/download/1.3/liberty-opentracing-zipkintracer-1.3-sample.zip \
    && cd /opt/ol/wlp/usr \
    && unzip liberty-opentracing-zipkintracer-1.3-sample.zip \
    && rm liberty-opentracing-zipkintracer-1.3-sample.zip \
    && wget https://github.com/jvm-profiling-tools/async-profiler/releases/download/v1.6/async-profiler-1.6-linux-x64.tar.gz -P /tmp \
    && tar -zxvf /tmp/async-profiler-1.6-linux-x64.tar.gz -C /tmp \
    && chown -R 1001:0 /tmp \
    && apt-get purge --auto-remove -y unzip \
    && apt-get purge --auto-remove -y wget \
    && rm -rf /var/lib/apt/lists/* \
    && chown -R 1001:0 /opt/ol/wlp/usr/extension
    
    
USER 1001

COPY --chown=1001:0 src/main/liberty/config/server.xml /config/server.xml
COPY --chown=1001:0 /src/main/liberty/config/jvm.options.base /config/jvm.options
COPY --chown=1001:0 /target/acmeair-customerservice-java-3.0.0-SNAPSHOT.war /config/apps/

# https://github.com/WASdev/ci.docker/#enterprise-functionality
ARG HTTP_ENDPOINT=true
#ARG MP_MONITORING=true
RUN configure.sh || if [ $? -ne 22 ]; then exit $?; fi
